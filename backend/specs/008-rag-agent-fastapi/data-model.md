# Data Model: Context-Aware RAG Agent with FastAPI

**Feature**: 008-rag-agent-fastapi
**Created**: 2025-12-13
**Status**: Draft

## Entity: AgentRequest

### Description
Represents a request to the RAG agent containing user query and optional selected text.

### Fields
- `request_id` (string): Unique identifier for the request
- `query` (string): The user's question or query
- `selected_text` (string, optional): Text selected by user in the frontend (nullable)
- `timestamp` (datetime): When the request was made
- `user_id` (string, optional): Identifier for the user making the request (nullable)
- `context_preferences` (dict): Preferences for context handling (nullable)

### Validation Rules
- `query` must not be empty or whitespace only
- `selected_text` length must be within configured limits if provided
- `request_id` must be unique
- `timestamp` must be current or past time

### Relationships
- One AgentRequest maps to one AgentResponse (one-to-one)
- One AgentRequest may trigger multiple RetrievedContext retrievals (one-to-many)

## Entity: AgentResponse

### Description
Represents the response generated by the RAG agent based on the provided context.

### Fields
- `response_id` (string): Unique identifier for the response
- `request_ref` (string): Reference to the original AgentRequest
- `answer` (string): The agent's answer to the query
- `sources` (list[dict]): List of sources used to generate the answer
- `confidence` (float): Confidence score for the response (0.0-1.0)
- `grounded_in_context` (bool): Whether the response is grounded in provided context
- `response_time_ms` (int): Time taken to generate the response in milliseconds
- `timestamp` (datetime): When the response was generated
- `fallback_used` (bool): Whether a fallback response was used

### Validation Rules
- `answer` must not be empty
- `confidence` must be between 0.0 and 1.0
- `response_time_ms` must be non-negative
- `request_ref` must reference an existing AgentRequest

### Relationships
- One AgentResponse belongs to one AgentRequest (one-to-one)
- One AgentResponse may reference multiple RetrievedContext items (many-to-many)

## Entity: RetrievedContext

### Description
Represents the context retrieved from Qdrant for use in agent reasoning.

### Fields
- `context_id` (string): Unique identifier for the context
- `request_ref` (string): Reference to the AgentRequest that triggered retrieval
- `chunks` (list[dict]): List of retrieved content chunks with metadata
- `relevance_scores` (list[float]): Similarity scores for each chunk
- `total_chunks` (int): Number of chunks retrieved
- `retrieval_method` (string): Method used for retrieval (vector, hybrid, etc.)
- `retrieval_time_ms` (int): Time taken for retrieval in milliseconds
- `retrieved_at` (datetime): When the context was retrieved

### Validation Rules
- `chunks` must not be empty
- `relevance_scores` must match length of chunks
- `total_chunks` must equal length of chunks list
- `relevance_scores` values must be between 0.0 and 1.0

### Relationships
- One RetrievedContext belongs to one AgentRequest (many-to-one)
- One RetrievedContext is used by one AgentResponse (many-to-one)

## Entity: ContextChunk

### Description
Represents a single chunk of content retrieved from the vector database.

### Fields
- `chunk_id` (string): Unique identifier for the chunk
- `content` (string): The actual text content of the chunk
- `url` (string): Source URL where the content was originally extracted from
- `title` (string): Page/section title from the source content
- `chunk_index` (int): Sequential index of the chunk within the source document
- `source_document` (string): Identifier for the original document
- `similarity_score` (float): Similarity score to the query (0.0-1.0)
- `priority_level` (string): Priority level (selected_text, high, medium, low)

### Validation Rules
- `content` must not be empty
- `url`, `title`, and `chunk_index` must be present
- `similarity_score` must be between 0.0 and 1.0
- `priority_level` must be one of: selected_text, high, medium, low

### Relationships
- One ContextChunk belongs to one RetrievedContext (many-to-one)
- ContextChunks are part of a RetrievedContext collection (one-to-many)

## Entity: AgentSession

### Description
Represents a logical session for tracking related agent interactions (though the API is stateless).

### Fields
- `session_id` (string): Unique identifier for the session
- `user_id` (string, optional): Identifier for the user (nullable)
- `first_request_time` (datetime): When the first request in session was made
- `last_request_time` (datetime): When the last request in session was made
- `request_count` (int): Number of requests in this session
- `status` (string): Status of the session (active, ended)

### Validation Rules
- `session_id` must be unique
- `request_count` must be non-negative
- `first_request_time` must be before or equal to `last_request_time`
- `status` must be one of: active, ended

### Relationships
- One AgentSession contains many AgentRequests (one-to-many)

## API Request/Response Models

### AgentQueryRequest (Pydantic Model)
```
{
  "query": "string (required) - User's question or query",
  "selected_text": "string (optional) - Text selected by user in frontend",
  "user_preferences": {
    "context_priority": "string (optional) - How to prioritize context (default: selected_text_first)",
    "response_length": "string (optional) - Desired response length (default: medium)"
  }
}
```

### AgentQueryResponse (Pydantic Model)
```
{
  "request_id": "string - Unique identifier for the request",
  "answer": "string - The agent's answer to the query",
  "sources": [
    {
      "content": "string - Snippet of the source content",
      "url": "string - Source URL",
      "title": "string - Source title",
      "similarity_score": "float - Relevance score (0.0-1.0)"
    }
  ],
  "confidence": "float - Confidence score for the response (0.0-1.0)",
  "grounded_in_context": "bool - Whether response is grounded in provided context",
  "response_time_ms": "int - Time taken to generate response",
  "fallback_used": "bool - Whether a fallback response was used"
}
```

### HealthCheckResponse (Pydantic Model)
```
{
  "status": "string - Overall health status (healthy, degraded, error)",
  "timestamp": "ISO 8601 datetime - When the check was performed",
  "services": {
    "openai_api": "string - Status of OpenAI API connection",
    "qdrant_db": "string - Status of Qdrant database connection",
    "agent_service": "string - Status of agent service"
  }
}
```